# -*- coding: utf-8 -*-
import scapy.all as scapy
import sys
from scapy.layers.dot11 import *
from scapy.layers.dot11 import Dot11, LLC, RadioTap, Dot11Beacon, Dot11Elt, Dot11ProbeResp
from scapy.layers.inet import UDP
from scapy.packet import Raw
from scapy.utils import hexdump, checksum
#from datos import *
import pickle5 as pickle
from funcionesbasica import *

ap_list = []                                #Lista de indices para controlar que paquetes nos han llegado
IFACE = 'wlx00c0caa81a35'                   #Interfaz de la targeta de red del transmisor
AP_MAC = '00:c0:ca:a8:1a:35'               #Direccion mac del transmisor
AP_MAC_2= '00:c0:ca:a4:73:7b'               #Direccion mac del receptor()
rates=0                                      #Velocidad de transmision
forma=0
#key = secrets.token_bytes(16)  # Aquí debería coger una clave asociada al receptor
key = b'\x01\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a'



#sendp(packet, iface=IFACE, verbose=False)

def PacketHandler(ps,xs,Hdr):
	print("Forma seleccionada: ",forma)
	if int(forma) == 2:
		packet = []
		print ("holaforma2")
		qoscontrol = b'\x00\x00'
		Hdr, mpduCi, ps, xs = cifrarCRTbasica(int(numdatip),int(tamdatip), ps, xs, Hdr)#tiene que leer paquetes eth de un fichero e ir enviandolos
		print(hexdump(mpduCi))
		packet.append(RadioTap(present='Rate',Rate=int(rates)) / Dot11(type=2, subtype=8, addr1=AP_MAC_2, addr2=AP_MAC,
		addr3=AP_MAC) / qoscontrol / mpduCi)
		sendp(packet, iface=IFACE, verbose=False)
	if int(forma) == 3:
		calcPRIMOS(1,1)


#Almacenamos el valor de la velocidad de transmision que se ha elegido
rates=sys.argv[1]
forma=sys.argv[2]
numdatip=sys.argv[3]	#numero de datagramas IP
tamdatip=sys.argv[4]	#tamaño de los datagramas I
#Claves
ps = [179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224137859, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224138297, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224139329, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224139931, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224140927, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224142551]
xs = [178117593182032400325712849907041910830393763617337748115819680008450813669851996974176865718067261956482015874126922962637454564855306598615664398147014698919689076506059682919875320539115621159315819774135123857472376360389301942197076876699846256851249697696678682719225948281594204464834174606742504703409, 93076610791855957694346669809202593149304489618454555331426443489342289801223521717609864066384749752120527802282053773757571869451721128197000457157594496369770010413246118917557648827141218642271628008305161726761518415707375262710763472745884135651651662688215072247639585191125809516893138183316092122817, 92668792837498315104989285189615958622656422813202722285405403331074896525499681642582651811459733081221897767646687969679997680440906372334663728031004982632985133347519793886437064325352800367076876628334502678428133584455481963567453352215629899582987340829082692414471787114814766325029976717014338149855, 27892267565162335210271952628974317969236730559388406101199562680132062837199217745658965190396303251936293463362304579485551036463788496213563587787372211049786397592783101128927809379343577887056148383063595386723183143143861282593944376384254716558161767438826427818851482367984279128295537969847518409544, 170916929114462789265456197284169372867155587508846660129540645502481497460345961232389240530284327724948791461485212982886518200384803147659644880832884172285523949882673728333924157222292650089489885244076918338120429613349164238851721520731165660920935910560328260342226481723567554424714189607666769387826, 51746261528546793164661007282665711988071213747704704372704730636566899321931516518140650352703059422984348406777337630729871022354517413305291523073488533972004893863933652518793826763249248098458486938821436296666303420325549661300573566441303615946048875637296036965833542513076284838792892607354686130441]
Hdr = 5455997945573795980481443035949586077142083430201394231941092344205402315333274100607867197883174434653613590416601648396569641413699998328723330381187140365897483317093084937325303372701688146138820521392729621040132849009923288567177429202860207477675709222486903676727401056236733586780893988096578463871370657155299025500403980918550083460390865704072520482769885968521209311983016598618870717131015708085207761791398302649326249679665650692607727248899745866232569256982297689533032934339661622791903946106534362605812729249469031227043629137531630764489847757206543870683850932679516044077275440028878705633186
PacketHandler(ps, xs, Hdr)
