# -*- coding: utf-8 -*-
import scapy.all as scapy
import sys
from scapy.layers.dot11 import *
from scapy.layers.dot11 import Dot11, LLC, RadioTap, Dot11Beacon, Dot11Elt, Dot11ProbeResp
from scapy.layers.inet import UDP
from scapy.packet import Raw
from scapy.utils import hexdump, checksum
import pickle5 as pickle
from ordenarpaquetes import ordenarpaquetes, colocarcabeceras, paquetesacifrar
from crearpaquetes import *
from funcionesbasicaoriginal import *


ap_list = []                                #Lista de indices para controlar que paquetes nos han llegado
IFACE = 'wlx00c0caa81a35'                   #Interfaz de la targeta de red del transmisor
AP_MAC = '00:c0:ca:a8:1a:35'               #Direccion mac del transmisor
AP_MAC_2= '00:c0:ca:a4:73:7b'               #Direccion mac del receptor()
rates=11                                     #Velocidad de transmision por defecto
forma=2
#key = secrets.token_bytes(16)  # Aquí debería coger una clave asociada al receptor
key = b'\x01\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a'


def PacketHandler(paquetes,ps,xs,Hdr):
	print("Forma seleccionada: ",forma)
	if int(forma) == 2:
		packet = []
		print ("transmito en forma2")
		qoscontrol = b'\x00\x00'
		mpduCi = cifrarCRTbasica(paquetes,ps,xs,Hdr)#tiene que leer paquetes eth de un fichero e ir enviandolos
		print(mpduCi)
		packet.append(RadioTap(present='Rate',Rate=int(rates)) / Dot11(type=2, subtype=8, addr1=AP_MAC_2, addr2=AP_MAC,
		addr3=AP_MAC) / qoscontrol / mpduCi)
		sendp(packet, iface=IFACE, verbose=False)
	if int(forma) == 3:
		calcPRIMOS(1,1)


#Almacenamos el valor de la velocidad de transmision que se ha elegido
# rates=sys.argv[1]
# forma=sys.argv[2]
		
paquetes = CrearPaquetes()  #Creamos los paquetes



paquetes_ordenados = ordenarpaquetes(paquetes)



paquetes_con_cabeceras = colocarcabeceras(paquetes_ordenados)
print("Paquetes con cabeceras:")
print(paquetes_con_cabeceras)
paquetes_a_cifrar, ps0, xs0, Hdr = paquetesacifrar(paquetes_con_cabeceras)

for paquete in paquetes_a_cifrar:
	print("paquetes_a_cifrar ")
	print(hexdump(paquete))
	

	
#CLAVES, Hay que mejorar el sistema de devolucion de claves.
psnew = [179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224137859, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224138297, 179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224139329]
xsnew = [118207959318671346915575425274520378714762884053238547522761731176486626739794131896819778042855412495877019689488412178440311294972372271961969527543008466264301553351498552942980514682127739145866641044872622863281377747534695434506927684935447472573792848072238191595699243973065161693017253476903750973522, 82014680142354232390469106986883432547476105845714451399841022619540067200183105478897296994717818236876535163411157472829935462273920328535502881676923001708232765494635183846834056955678518174642386344940685806925651949254129812554432923212731563591321933393331825512793363986030705611650509226521891389163, 63793671105087392486896550159419068572504904449463592968901569824850431353300631156368380484873272077134825112914369461175236406888596416867023277581681028893453398091110759652739255008879701340399135033726288404711187357567515833066880879988169829451380825685249150706447705888816904655306766688336062394701]

# paquetes_a_cifrar[0]= paquete2

print("paquetesacifrar",paquetes_a_cifrar)
PacketHandler(paquetes_a_cifrar,psnew,xsnew,Hdr)
