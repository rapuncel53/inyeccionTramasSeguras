
#!/usr/bin/env python
# import scapy module
import sys
import scapy.all as scapy
from scapy.layers.dot11 import Dot11, RadioTap, Dot11Elt, Dot11EltHTCapabilities, Dot11AssoReq
from scapy.sendrecv import sendp
#from Generatramas import *
#from Criptotramas import *
#from datos import *
from funcionesbasicaoriginal import *
 
ap_list = []
IFACE2 = 'wlx00c0caa4737b'
AP_MAC_2 = '00:c0:ca:a4:73:7b'#mac rx
AP_MAC= '00:c0:ca:a8:1a:35'#mac tx
rate=11
forma = 2
key = b'\x01\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a\x03\x0a'

#CLAVES
ps = [179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224138297, 
      179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224139329]
xs = [47457508624699592571879567843540731024625546845848739956546481586921924122361875573606779874466906387096415574245441238229301952888491580166203596930912460091762900137402627171459617075126076008449255766677286781312372524680897817271780098253172285273456386860825099720900820682235344377141978841428423350192, 
      116770491728068574270330589294353366814139093988554014810026857452069221510316651810180084551630623002387173175167742957266565954519701397184523182281240267534053530776030854115866261043321473431618237468937097815301236760041286527564974876962011089984195713383866961681179550388784129003601742639980904599769]
Hdr = 2843796326746969865517775137331587486046904811886503323102856146256129856445998934622446266251760018784185737111736108364839797946641759100223128000616308091539303132799727619266259596828149083874517781740179944644935556803289876169647362898861310839047877703563616025850495911850867054594022211735083536843875628987627216327719706741910036986827677832845686557780528840150455730953809234694322995111692138428714417268185133762942049850455209445920069601946607745983683598930918306972219800721120122707225650964714727753960963676306745813930269021935324632162446815277154321124916795985950915416767654347652388677539

def PacketHandler(pkt):     #RECEPCION DE SIEMPRE
    # Capturamos el AMPDU
    #print("tipo",pkt.subtype)
    if pkt.type == 2 and pkt.subtype == 8 and pkt.addr1==AP_MAC_2:
        if pkt.subtype not in ap_list:
            #ap_list.append(pkt.subtype)
            ver=pkt.getlayer(Dot11)
            print("LONGITUD ENTRADA RADIO",len(ver))
            print(hexdump(ver))
            n=0
            numero=int.from_bytes(ver, byteorder='big')
            hexa=numero.to_bytes((numero.bit_length() + 7) // 8, byteorder='big')
            print("LONGITUD conversion entrada", len(hexa))

            AMPDU_FINAL = b''
            for i in hexa:
                #print(hex(i))
                if n<(len(hexa)-4) and n>=26:
                    if i != 0:
                        by = i.to_bytes((i.bit_length() + 7) // 8, byteorder='big')
                        AMPDU_FINAL = AMPDU_FINAL + by
                    else:
                        AMPDU_FINAL = AMPDU_FINAL + b'\x00'

                n = n + 1
            print(hexdump(AMPDU_FINAL))
            intAMPDUfinal=int.from_bytes(AMPDU_FINAL, byteorder='big')

            if int(forma) == 2:
                MSDUs = AMSDU_dec_limpia(Hdr, intAMPDUfinal, ps, xs)
                print (MSDUs)
                #nuevo=MSDUs.to_bytes((MSDUs.bit_length() + 7) // 8, byteorder='big')
                paquetes_recibidos = []
                for i in MSDUs:
                    x=i.to_bytes((i.bit_length() + 7) // 8, byteorder='big')
                    print(hexdump(x))
                    
                
            #exit()
            print("SALIMOS")
            
            #MSDU, lapso = AMPDU_dec(int.from_bytes(ver, byteorder='big'), key)

# rate = sys.argv[1]
# forma= sys.argv[2]

scapy.sniff(iface=IFACE2, prn=PacketHandler, timeout=30000)
 